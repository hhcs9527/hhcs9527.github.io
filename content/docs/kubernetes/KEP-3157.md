---
title: "KEP-3157 Watch List"
type: docs
---

## Problem
For every watcher to read the data from informer, it require to List the data first, then watch the event changes, which brought
	- If there are many watcher, it will operate the same things.
	- Each List will do the following
        1. LIST RV="0" request
           - Require the entire etcd read, which will cause the high mem usage for loading the data
           - The moment where data read it will has the issue, may not consist
        2. WATCH the resource
        3. When the data is either expired or compact, will start from #1


## Solution
Watch list

## Lession learn

### Why does the stream can alleviate the memeory
- stream background is ?
- code where they use the stream
- code experiment, vanilla v.s. my own implementation
### How to get the alert for the apiserver?
### step2.
- upon receiving the request from an informer, contact etcd to get the latest RV. It will be used to make sure the watch cache has seen objects up to the received RV. This step is necessary and ensures we will serve consistent data, even from the cache.
- why can we ensure it upto date?
- cold start of etcd?

### How does sample apiserver works on watch list implementation?

### bookmark event
### list RV = 0



### Env
### Code to test it
### Code to test it
<a id="bookmark-ref"></a>
- â€¦ [bookmark](#bookmark-note)

<a id="rv-empty-ref"></a>
- â€¦ [RV=""](#rv-empty-note)

<a id="rv-0-ref"></a>
- â€¦ [RV=0](#rv-0-note)


### trade off using the RV=0 with CAP
# ResourceVersion åƒæ•¸å°æ¯”

## æ ¸å¿ƒå·®ç•°

### `RV=""` - å¼·ä¸€è‡´æ€§ä¿è­‰
- **è³‡æ–™ä¾†æº**: ç›´æ¥å¾ etcd é€²è¡Œ **Quorum Read**
- **ä¸€è‡´æ€§**: **å¼·ä¸€è‡´æ€§** - ä¿è­‰ç²å¾—æœ€æ–°æäº¤çš„è³‡æ–™
- **æ•ˆèƒ½ä»£åƒ¹**: è¼ƒé«˜å»¶é²ï¼Œéœ€è¦ç­‰å¾…å¤šæ•¸ç¯€é»ç¢ºèª
- **ä½¿ç”¨å ´æ™¯**:
  - Informer åˆå§‹åŒ–å¾Œçš„ä¸€è‡´æ€§åŒæ­¥
  - éŒ¯èª¤æ¢å¾© (410 ResourceExpired)
  - é—œéµæ“ä½œéœ€è¦æœ€æ–°ç‹€æ…‹æ™‚
- **CAP æ¬Šè¡¡**: é¸æ“‡ **CP** (ä¸€è‡´æ€§ + åˆ†å€å®¹å¿æ€§)

### `RV="0"` - æœ€ä½³åŠªåŠ›å¯ç”¨æ€§
- **è³‡æ–™ä¾†æº**: å¾ **Watch Cache** è®€å– (å¦‚æœå¯ç”¨)
- **ä¸€è‡´æ€§**: **æœ€çµ‚ä¸€è‡´æ€§** - å¯èƒ½è¿”å›éæ™‚è³‡æ–™
- **æ•ˆèƒ½å„ªå‹¢**: ä½å»¶é²ï¼Œé«˜å¯ç”¨æ€§
- **é¢¨éšª**:
  - å¯èƒ½è®€å–åˆ°éæ™‚ç‹€æ…‹
  - åœ¨ HA ç’°å¢ƒä¸­å¯èƒ½å‡ºç¾æ™‚é–“å€’æµ
  - Watch cache å¯èƒ½è½å¾Œæ–¼ etcd
- **CAP æ¬Šè¡¡**: åå‘ **AP** (å¯ç”¨æ€§ + åˆ†å€å®¹å¿æ€§)

## å¯¦éš›è¡Œç‚ºå°æ¯”

| å ´æ™¯ | `RV=""` | `RV="0"` |
|------|---------|----------|
| è³‡æ–™æ–°é®®åº¦ | âœ… ä¿è­‰æœ€æ–° | âš ï¸ å¯èƒ½éæ™‚ |
| è®€å–å»¶é² | ğŸŒ è¼ƒé«˜ | âš¡ è¼ƒä½ |
| ç¶²è·¯åˆ†å€æ™‚ | ğŸ›¡ï¸ æ‹’çµ•æœå‹™ä¿è­‰ä¸€è‡´æ€§ | ğŸ“± ç¹¼çºŒæœå‹™ä½†å¯èƒ½ä¸ä¸€è‡´ |
| etcd è² è¼‰ | ğŸ“ˆ ç›´æ¥æŸ¥è©¢ | ğŸ“‰ ä½¿ç”¨å¿«å– |
| è¨˜æ†¶é«”ä½¿ç”¨ | ğŸ’¾ æŒ‰éœ€åˆ†é  | ğŸ’¥ å¯èƒ½å¤§é‡è¨˜æ†¶é«” |

## ä½¿ç”¨å»ºè­°

### é¸æ“‡ `RV=""` ç•¶ï¼š
- éœ€è¦å¼·ä¸€è‡´æ€§ä¿è­‰
- å¯ä»¥æ¥å—è¼ƒé«˜å»¶é²
- åˆå§‹åŒ–æˆ–éŒ¯èª¤æ¢å¾©å ´æ™¯
- å®‰å…¨é—œéµæ“ä½œ

### é¸æ“‡ `RV="0"` ç•¶ï¼š
- éœ€è¦ä½å»¶é²éŸ¿æ‡‰
- å¯ä»¥å®¹å¿çŸ­æš«ä¸ä¸€è‡´
- é«˜é »æŸ¥è©¢å ´æ™¯
- ç›£æ§æˆ–å±•ç¤ºç”¨é€”

## KEP 3157 çš„æ”¹é€²

æ–°çš„ Watch-List æ–¹æ³•çµåˆå…©è€…å„ªå‹¢ï¼š

```
1. ä½¿ç”¨ RV="" å»ºç«‹ä¸€è‡´æ€§åŸºæº–é»
2. ç­‰å¾… Watch Cache åŒæ­¥åˆ°è©²åŸºæº–é»
3. å¾ Watch Cache é€²è¡Œé«˜æ•ˆä¸²æµå‚³è¼¸
```

é€™ç¨®æ–¹å¼æ—¢ä¿è­‰äº†ä¸€è‡´æ€§ï¼Œåˆé¿å…äº†è¨˜æ†¶é«”çˆ†ç‚¸å•é¡Œã€‚

## Experiment

## Reference
- [KEP-3157](https://github.com/kubernetes/enhancements/blob/master/keps/sig-api-machinery/3157-watch-list/README.md)

---

### Note

### Note
<a id="bookmark-note"></a>
- **Bookmark Event** â€” a Kubernetes watch event that notifies the client of the query object's resource version. [â†©](#bookmark-ref)

<a id="rv-empty-note"></a>
- RV="" â€” etcd issues a quorum read, guaranteeing the latest committed data. [â†©](#rv-empty-ref)

<a id="rv-0-note"></a>
- RV=0 â€” etcd serves the request without quorum; the response may be stale. [â†©](#rv-0-ref)
